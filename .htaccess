# Force HTTPS and strip www
RewriteEngine On
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} ^www\. [NC]
RewriteRule ^(.*)$ https://sos.izignamx.com/ [R=301,L]

# Serve modern caching headers for static assets
<IfModule mod_headers.c>
  <FilesMatch "\.(html|json|webmanifest)$">
    Header set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' 'unsafe-inline' https://analytics.izignamx.com; img-src 'self' data: https://izignamx.com https://wa.me; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://analytics.izignamx.com; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
    Header set Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=()"
    Header set X-Content-Type-Options "nosniff"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Cross-Origin-Opener-Policy "same-origin"
    Header set X-Frame-Options "DENY"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  </FilesMatch>

  <FilesMatch "\.(css|js|png|jpg|jpeg|svg|ico|webp|woff2?)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  <FilesMatch "\.(html|json|webmanifest)$">
    Header set Cache-Control "public, max-age=300"
  </FilesMatch>
</IfModule>

# Gzip / Brotli (if supported)
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>

# Deny access to hidden files
<FilesMatch "^\.">
  Require all denied
</FilesMatch>

# Redirect legacy paths to new legal pages if needed
Redirect 301 /privacy /privacy.html
Redirect 301 /security /security.html

# Allow service worker and manifest to be served with correct MIME types
AddType application/manifest+json .webmanifest
AddType text/javascript .js

# Fallback to index.html for missing routes (PWA offline support)
FallbackResource /index.html
